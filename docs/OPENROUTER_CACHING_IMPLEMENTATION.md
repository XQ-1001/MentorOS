# OpenRouter æç¤ºè¯ç¼“å­˜å®æ–½æŒ‡å— / OpenRouter Prompt Caching Implementation Guide

**å®æ–½æ—¥æœŸ / Implementation Date:** 2025-12-10
**çŠ¶æ€ / Status:** âœ… å·²å®æ–½ / Implemented

---

## ğŸ“‹ æ¦‚è¿° / Overview

æœ¬é¡¹ç›®å·²æˆåŠŸå®æ–½ OpenRouter çš„ Gemini æç¤ºè¯ç¼“å­˜åŠŸèƒ½ï¼Œç”¨äºä¼˜åŒ– 70KB ç³»ç»Ÿæç¤ºè¯çš„å¤„ç†å»¶è¿Ÿå’Œæˆæœ¬ã€‚

**æ ¸å¿ƒä¼˜åŠ¿ / Key Benefits:**
- âœ… ç¼“å­˜å‘½ä¸­æ—¶å»¶è¿Ÿé™ä½ 20-40%
- âœ… ç¼“å­˜å‘½ä¸­æ—¶æˆæœ¬é™ä½ 75%ï¼ˆ0.25Ã— åŸä»·ï¼‰
- âœ… æ— éœ€ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯å†…å®¹
- âœ… ä¿æŒ AI è§’è‰²è´¨é‡ä¸å˜

---

## ğŸ”§ æŠ€æœ¯å®ç° / Technical Implementation

### ä¿®æ”¹æ–‡ä»¶ / Modified Files

**æ–‡ä»¶**: `app/api/chat/route.ts`
**ä¿®æ”¹ä½ç½®**: app/api/chat/route.ts:30-39

### ä¿®æ”¹å‰ / Before

```typescript
messages: [
  {
    role: 'system',
    content: systemInstruction  // å­—ç¬¦ä¸²æ ¼å¼
  },
  ...messages
]
```

### ä¿®æ”¹å / After

```typescript
messages: [
  {
    role: 'system',
    content: [
      {
        type: 'text',
        text: systemInstruction,
        cache_control: { type: 'ephemeral' }  // â† ç¼“å­˜æ ‡è®°
      }
    ]
  },
  ...messages
]
```

### å…³é”®å˜åŒ– / Key Changes

1. **Content æ ¼å¼å˜åŒ–**:
   - ä»: `content: string`
   - åˆ°: `content: Array<{ type, text, cache_control }>`

2. **ç¼“å­˜æ ‡è®°**:
   - `cache_control: { type: 'ephemeral' }`
   - è¡¨ç¤ºä½¿ç”¨çŸ­æœŸï¼ˆ5åˆ†é’Ÿï¼‰ç¼“å­˜

3. **å…¼å®¹æ€§**:
   - ç¬¦åˆ OpenRouter API è§„èŒƒ
   - ä¸ Anthropic çš„ç¼“å­˜è¯­æ³•ä¸€è‡´
   - å¯¹ä¸æ”¯æŒç¼“å­˜çš„æ¨¡å‹æ— å½±å“ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰

---

## ğŸš€ å·¥ä½œåŸç† / How It Works

### ç¼“å­˜ç”Ÿå‘½å‘¨æœŸ / Cache Lifecycle

```
ç”¨æˆ·è¯·æ±‚ 1 (é¦–æ¬¡)
    â†“
ç³»ç»Ÿæç¤ºè¯ (70KB) â†’ OpenRouter API
    â†“
Cache Write (å†™å…¥ç¼“å­˜)
    â†“
è¿”å›å“åº” (æ­£å¸¸å»¶è¿Ÿ)
    â†“
[5åˆ†é’Ÿå†…...]
    â†“
ç”¨æˆ·è¯·æ±‚ 2 (åç»­)
    â†“
ç³»ç»Ÿæç¤ºè¯ (70KB) â†’ OpenRouter API
    â†“
Cache Read (å‘½ä¸­ç¼“å­˜) â† 75% æˆæœ¬æŠ˜æ‰£
    â†“
è¿”å›å“åº” (å»¶è¿Ÿé™ä½ 20-40%)
    â†“
[5åˆ†é’Ÿåç¼“å­˜è¿‡æœŸ]
    â†“
ç”¨æˆ·è¯·æ±‚ 3 â†’ é‡æ–° Cache Write
```

### ç¼“å­˜ç­–ç•¥ / Caching Strategy

| è¯·æ±‚ç±»å‹ | ç¼“å­˜çŠ¶æ€ | å»¶è¿Ÿ | æˆæœ¬ | Token å¤„ç† |
|---------|---------|------|------|-----------|
| é¦–æ¬¡è¯·æ±‚ | Cache Write | æ­£å¸¸ | 100% + å­˜å‚¨è´¹ | å®Œæ•´å¤„ç† 70KB |
| 5åˆ†é’Ÿå†… | Cache Hit | -20~40% | 25% | è·³è¿‡ 70KB |
| 5åˆ†é’Ÿå | Cache Miss | æ­£å¸¸ | 100% + å­˜å‚¨è´¹ | å®Œæ•´å¤„ç† 70KB |

**Cache TTL (Time-to-Live)**: 5 åˆ†é’Ÿï¼ˆå›ºå®šï¼Œä¸å¯å»¶é•¿ï¼‰

---

## ğŸ“Š é¢„æœŸæ•ˆæœ / Expected Impact

### å»¶è¿Ÿæ”¹å–„ / Latency Improvement

**å½“å‰ä½¿ç”¨ Gemini 3 Pro Preview:**
- é¦–æ¬¡è¯·æ±‚: 60-90 ç§’ï¼ˆæ— å˜åŒ–ï¼‰
- ç¼“å­˜å‘½ä¸­: **45-65 ç§’**ï¼ˆæ”¹å–„ 25-30%ï¼‰

**å¦‚åˆ‡æ¢åˆ° Gemini 2.0 Flashï¼ˆæ–¹æ¡ˆ Aï¼‰:**
- é¦–æ¬¡è¯·æ±‚: 20-30 ç§’ï¼ˆæ— å˜åŒ–ï¼‰
- ç¼“å­˜å‘½ä¸­: **12-20 ç§’**ï¼ˆæ”¹å–„ 30-40%ï¼‰âœ… æ¨èç»„åˆ

### æˆæœ¬èŠ‚çœ / Cost Savings

**å‡è®¾æ¯å¤© 100 æ¬¡å¯¹è¯è¯·æ±‚:**

**æ— ç¼“å­˜:**
```
100 æ¬¡è¯·æ±‚ Ã— 70KB Ã— æ ‡å‡†ä»·æ ¼ = 7000KB tokens è´¹ç”¨
```

**æœ‰ç¼“å­˜ï¼ˆå‡è®¾ 60% å‘½ä¸­ç‡ï¼‰:**
```
40 æ¬¡ Cache Write Ã— 70KB Ã— æ ‡å‡†ä»·æ ¼ = 2800KB tokens è´¹ç”¨
60 æ¬¡ Cache Read Ã— 70KB Ã— 0.25 Ã— æ ‡å‡†ä»·æ ¼ = 1050KB tokens è´¹ç”¨
æ€»è®¡ = 3850KB tokens è´¹ç”¨

èŠ‚çœ = (7000 - 3850) / 7000 = 45% æˆæœ¬é™ä½
```

**å®é™…èŠ‚çœå–å†³äº:**
- ç”¨æˆ·æ´»è·ƒåº¦ï¼ˆ5åˆ†é’Ÿå†…è¿ç»­å¯¹è¯é¢‘ç‡ï¼‰
- å¯¹è¯æ—¶é•¿
- ç”¨æˆ·æ•°é‡

---

## ğŸ” ç›‘æ§ä¸éªŒè¯ / Monitoring and Verification

### OpenRouter ä½¿ç”¨ç»Ÿè®¡ / Usage Statistics

è®¿é—® [OpenRouter Dashboard](https://openrouter.ai/activity) æŸ¥çœ‹ï¼š

1. **Total Usage** - æ€» token ä½¿ç”¨é‡
2. **Cached Tokens** - ç¼“å­˜å‘½ä¸­çš„ token æ•°é‡
3. **Cache Hit Rate** - ç¼“å­˜å‘½ä¸­ç‡ï¼ˆè‡ªè¡Œè®¡ç®—ï¼‰

### API å“åº”å­—æ®µ / API Response Fields

OpenRouter è¿”å›çš„å“åº”ä¸­åŒ…å« `usage` å¯¹è±¡ï¼ˆå½“å¯ç”¨ usage accounting æ—¶ï¼‰ï¼š

```json
{
  "usage": {
    "prompt_tokens": 1000,
    "completion_tokens": 500,
    "cached_tokens": 17500  // â† ä»ç¼“å­˜è¯»å–çš„ token æ•°é‡
  }
}
```

**æ³¨æ„**: éœ€è¦åœ¨ API è¯·æ±‚ä¸­å¯ç”¨ usage accounting æ‰èƒ½çœ‹åˆ°è¯¦ç»†ç»Ÿè®¡ã€‚

### æœ¬åœ°æµ‹è¯• / Local Testing

**æµ‹è¯•æ­¥éª¤:**

1. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**:
   ```bash
   npm run dev
   ```

2. **å‘é€é¦–æ¡æ¶ˆæ¯**ï¼ˆCache Writeï¼‰:
   - æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
   - è®°å½• Network ä¸­ `/api/chat` çš„å“åº”æ—¶é—´
   - ä¾‹å¦‚: 65 ç§’

3. **5åˆ†é’Ÿå†…å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯**ï¼ˆCache Hitï¼‰:
   - åŒæ ·è®°å½•å“åº”æ—¶é—´
   - ä¾‹å¦‚: 42 ç§’
   - æ”¹å–„å¹…åº¦: (65-42)/65 = 35% âœ…

4. **ç­‰å¾…è¶…è¿‡ 5 åˆ†é’Ÿåå†æµ‹è¯•**ï¼ˆCache Expiredï¼‰:
   - å“åº”æ—¶é—´åº”è¯¥æ¢å¤åˆ°é¦–æ¬¡æ°´å¹³ï¼ˆçº¦ 65 ç§’ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹ / Important Notes

### é™åˆ¶ä¸çº¦æŸ / Limitations

1. **5åˆ†é’Ÿ TTL æ— æ³•å»¶é•¿**:
   - å³ä½¿ç”¨æˆ·æŒç»­å¯¹è¯ï¼Œç¼“å­˜ä¹Ÿä¼šåœ¨ 5 åˆ†é’Ÿåè¿‡æœŸ
   - æ— æ³•é€šè¿‡ API å‚æ•°ä¿®æ”¹ TTL

2. **ä»…å¯¹è¿ç»­å¯¹è¯æœ‰æ•ˆ**:
   - ç”¨æˆ·éœ€è¦åœ¨ 5 åˆ†é’Ÿå†…å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯æ‰èƒ½å—ç›Š
   - é•¿æ—¶é—´ä¸æ´»è·ƒçš„ç”¨æˆ·ä¸ä¼šè·å¾—ç¼“å­˜ä¼˜åŠ¿

3. **Gemini ç‰¹å®šé™åˆ¶**:
   - OpenRouter æ–‡æ¡£æŒ‡å‡º Gemini åªä½¿ç”¨æœ€åä¸€ä¸ª cache_control breakpoint
   - å¤šä¸ª breakpoint å¯¹ Gemini æ— æ•ˆï¼ˆä½†å¯¹ Anthropic æœ‰æ•ˆï¼‰

4. **æ¨¡å‹æ”¯æŒ**:
   - **Gemini ç³»åˆ—**: éœ€è¦æ˜¾å¼ `cache_control` æ ‡è®° âœ…
   - **Anthropic Claude**: éœ€è¦æ˜¾å¼ `cache_control` æ ‡è®°
   - **OpenAI GPT**: è‡ªåŠ¨ç¼“å­˜ï¼ˆæ— éœ€æ ‡è®°ï¼‰
   - **Grok, Groq, Moonshot**: è‡ªåŠ¨ç¼“å­˜ï¼ˆæ— éœ€æ ‡è®°ï¼‰

### å‘ä¸‹å…¼å®¹æ€§ / Backward Compatibility

**å¦‚æœ API ä¸æ”¯æŒç¼“å­˜:**
- OpenRouter ä¼šå¿½ç•¥ `cache_control` å­—æ®µ
- è¯·æ±‚ä»ç„¶æ­£å¸¸å¤„ç†
- æ— é”™è¯¯æˆ–è­¦å‘Š

**å¦‚æœåˆ‡æ¢åˆ°é Gemini æ¨¡å‹:**
- `cache_control` æ ‡è®°ä»ç„¶æœ‰æ•ˆï¼ˆå¯¹ Anthropicï¼‰
- å¯¹è‡ªåŠ¨ç¼“å­˜æ¨¡å‹ï¼ˆOpenAI, Grokï¼‰æ— å½±å“
- æ— éœ€ä¿®æ”¹ä»£ç 

---

## ğŸ§ª æµ‹è¯•å»ºè®® / Testing Recommendations

### æµ‹è¯•åœºæ™¯ / Test Scenarios

1. **çŸ­æœŸè¿ç»­å¯¹è¯æµ‹è¯•**:
   - 5åˆ†é’Ÿå†…å‘é€ 3-5 æ¡æ¶ˆæ¯
   - éªŒè¯ç¬¬ 2-5 æ¡æ¶ˆæ¯çš„å“åº”æ—¶é—´ç¼©çŸ­

2. **ç¼“å­˜è¿‡æœŸæµ‹è¯•**:
   - å‘é€é¦–æ¡æ¶ˆæ¯
   - ç­‰å¾… 6 åˆ†é’Ÿ
   - å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆåº”è¯¥æ— ç¼“å­˜ä¼˜åŠ¿ï¼‰

3. **å¤šç”¨æˆ·æµ‹è¯•**:
   - ä¸åŒç”¨æˆ·çš„ç¼“å­˜æ˜¯ç‹¬ç«‹çš„
   - ç”¨æˆ· A çš„ç¼“å­˜ä¸å½±å“ç”¨æˆ· B

4. **é•¿å¯¹è¯æµ‹è¯•**:
   - 10+ è½®å¯¹è¯
   - éªŒè¯ç¼“å­˜åœ¨æ¯ä¸ª 5 åˆ†é’Ÿå‘¨æœŸå†…çš„è¡¨ç°

### æ€§èƒ½åŸºå‡† / Performance Benchmarks

**ç›®æ ‡å»¶è¿Ÿï¼ˆä½¿ç”¨ Gemini 2.0 Flash + ç¼“å­˜ï¼‰:**
- é¦–æ¬¡è¯·æ±‚: 20-30 ç§’
- ç¼“å­˜å‘½ä¸­: 12-20 ç§’
- ç¼“å­˜è¿‡æœŸå: 20-30 ç§’ï¼ˆé‡æ–°å†™å…¥ï¼‰

**å¦‚æœå®é™…å»¶è¿Ÿè¶…å‡ºç›®æ ‡:**
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ£€æŸ¥ OpenRouter API çŠ¶æ€
- æ£€æŸ¥ç³»ç»Ÿæç¤ºè¯å¤§å°æ˜¯å¦å¢åŠ 
- è€ƒè™‘å®æ–½æ–¹æ¡ˆ Aï¼ˆåˆ‡æ¢åˆ°æ›´å¿«çš„æ¨¡å‹ï¼‰æˆ–æ–¹æ¡ˆ Bï¼ˆå‹ç¼©æç¤ºè¯ï¼‰

---

## ğŸ”— å‚è€ƒèµ„æ–™ / References

### å®˜æ–¹æ–‡æ¡£ / Official Documentation

- [OpenRouter Prompt Caching Guide](https://openrouter.ai/docs/guides/best-practices/prompt-caching)
- [OpenRouter Usage Accounting](https://openrouter.ai/docs/use-cases/usage-accounting)
- [OpenRouter Gemini Caching Announcement](https://x.com/OpenRouterAI/status/1914699401127157933)

### ç›¸å…³è®¨è®º / Related Discussions

- [Is Implicit Caching Prompt Retention?](https://openrouter.ai/announcements/is-implicit-caching-prompt-retention)
- [Prompt Caching with OpenRouter Sonnet 3.5 - GitHub Issue](https://github.com/paul-gauthier/aider/issues/1615)

### å†…éƒ¨æ–‡æ¡£ / Internal Documentation

- `docs/LATENCY_ANALYSIS.md` - å®Œæ•´çš„å»¶è¿Ÿåˆ†ææŠ¥å‘Š
- `app/api/chat/route.ts` - API è·¯ç”±å®ç°
- `constants.ts` - ç³»ç»Ÿæç¤ºè¯å®šä¹‰
- `lib/steveJobsContext.ts` - 60KB å†å²ä¸Šä¸‹æ–‡

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ– / Next Optimizations

**å¦‚æœç¼“å­˜æ•ˆæœä»ä¸æ»¡æ„ï¼Œå¯ä»¥è€ƒè™‘:**

1. **æ–¹æ¡ˆ A - åˆ‡æ¢æ¨¡å‹**:
   ```bash
   # .env.local
   CHAT_MODEL_ID=google/gemini-2.0-flash-001
   ```
   - ä¸ç¼“å­˜é…åˆï¼Œå»¶è¿Ÿå¯é™è‡³ 12-20 ç§’ï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰

2. **æ–¹æ¡ˆ B - å‹ç¼©æç¤ºè¯**:
   - å°† 70KB å‹ç¼©è‡³ 20-30KB
   - ä¿ç•™æ ¸å¿ƒç‰¹å¾ï¼Œåˆ é™¤å†—ä½™å†…å®¹
   - éœ€è¦å¤§é‡æµ‹è¯•

3. **æ–¹æ¡ˆ D - å¯¹è¯å†å²ç®¡ç†**:
   - å®æ–½æ»‘åŠ¨çª—å£ï¼ˆä¿ç•™æœ€è¿‘ 10-15 è½®ï¼‰
   - é˜²æ­¢é•¿å¯¹è¯çš„ token ç´¯ç§¯

4. **æ–¹æ¡ˆ E - é™ä½ max_tokens**:
   - ä» 4096 é™è‡³ 2048
   - å¼ºåˆ¶ AI æ›´ç®€æ´

---

## ğŸ“ é—®é¢˜åé¦ˆ / Issue Reporting

**å¦‚æœå‘ç°é—®é¢˜:**

1. æ£€æŸ¥ OpenRouter Dashboard çš„ä½¿ç”¨ç»Ÿè®¡
2. ç¡®è®¤ `cached_tokens` å­—æ®µæ˜¯å¦æœ‰æ•°å€¼
3. è®°å½•å…·ä½“çš„å»¶è¿Ÿæ—¶é—´å’Œç¼“å­˜å‘½ä¸­ç‡
4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°å’ŒæœåŠ¡å™¨æ—¥å¿—
5. å‚è€ƒæœ¬æ–‡æ¡£çš„"ç›‘æ§ä¸éªŒè¯"ç« èŠ‚

**å¸¸è§é—®é¢˜æ’æŸ¥:**

- **ç¼“å­˜æœªç”Ÿæ•ˆ**: ç¡®è®¤æ¨¡å‹æ˜¯ Gemini ç³»åˆ—ï¼Œæ£€æŸ¥ `cache_control` è¯­æ³•
- **å»¶è¿Ÿæœªæ”¹å–„**: ç¡®è®¤åœ¨ 5 åˆ†é’Ÿå†…å‘é€åç»­æ¶ˆæ¯ï¼Œæ£€æŸ¥ç½‘ç»œçŠ¶å†µ
- **æˆæœ¬æœªé™ä½**: ç¡®è®¤ OpenRouter ç»Ÿè®¡ä¸­æœ‰ `cached_tokens` è®°å½•

---

**æ–‡æ¡£ç‰ˆæœ¬ / Document Version:** 1.0
**æœ€åæ›´æ–° / Last Updated:** 2025-12-10
**ç»´æŠ¤è€… / Maintainer:** Development Team
