# Profiles Table Migration - å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. Header ç»„ä»¶ (`components/Header.tsx`)

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ·»åŠ  `profile` çŠ¶æ€å­˜å‚¨ç”¨æˆ·èµ„æ–™
- âœ… æ·»åŠ  `fetchProfile()` å‡½æ•°ä» `public.profiles` è¡¨è¯»å–æ•°æ®
- âœ… åœ¨ç”¨æˆ·ç™»å½•æ—¶è‡ªåŠ¨è·å– profile æ•°æ®
- âœ… ç›‘å¬ `profileUpdated` äº‹ä»¶ï¼Œå½“ç”¨æˆ·ä¿å­˜è®¾ç½®æ—¶è‡ªåŠ¨åˆ·æ–°
- âœ… æ˜¾ç¤ºå¤´åƒå’Œåå­—æ—¶ä½¿ç”¨ `profile` è€Œä¸æ˜¯ `user.user_metadata`

**æ•°æ®æµï¼š**
```
ç™»å½• â†’ fetchProfile(user.id) â†’ profiles è¡¨ â†’ setProfile() â†’ æ˜¾ç¤º
```

### 2. UserSettingsModal ç»„ä»¶ (`components/UserSettingsModal.tsx`)

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ‰“å¼€æ¨¡æ€æ¡†æ—¶ä» `public.profiles` è¡¨è¯»å–å½“å‰æ•°æ®
- âœ… ä¿å­˜æ—¶æ›´æ–° `public.profiles` è¡¨ï¼Œè€Œä¸æ˜¯ `auth.updateUser()`
- âœ… å¤´åƒä¸Šä¼ æˆåŠŸåï¼Œæ–°çš„ `avatar_url` ä¼šæ›´æ–°åˆ° profiles è¡¨
- âœ… ä¿å­˜æˆåŠŸåè§¦å‘ `profileUpdated` äº‹ä»¶é€šçŸ¥å…¶ä»–ç»„ä»¶

**ä¿å­˜é€»è¾‘ï¼š**
```javascript
await supabase
  .from('profiles')
  .update({
    name: displayName,
    avatar_url: avatarUrl
  })
  .eq('id', user.id);
```

### 3. ä¸»é¡µé¢ (`app/page.tsx`)

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ·»åŠ  `profile` çŠ¶æ€
- âœ… æ·»åŠ  `fetchProfile()` å‡½æ•°
- âœ… ç™»å½•æ—¶è·å– profile æ•°æ®
- âœ… ç›‘å¬ `profileUpdated` äº‹ä»¶
- âœ… MessageBubble ä½¿ç”¨ `profile.name` å’Œ `profile.avatar_url`

## ğŸ¯ å·¥ä½œåŸç†

### æ•°æ®æµå›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User æ³¨å†Œ/ç™»å½•  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Trigger   â”‚  (è‡ªåŠ¨åˆ›å»º profiles è®°å½•)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  public.profiles    â”‚  â† å”¯ä¸€çœŸå®æ¥æº
â”‚  - id (user.id)     â”‚
â”‚  - name             â”‚
â”‚  - avatar_url       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ç»„ä»¶è¯»å–        â”‚
â”‚  supabase           â”‚
â”‚    .from('profiles')â”‚
â”‚    .select(...)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ›´æ–°æµç¨‹
```
ç”¨æˆ·ä¿å­˜è®¾ç½®
    â†“
supabase.from('profiles').update(...)
    â†“
æ•°æ®åº“æ›´æ–°æˆåŠŸ
    â†“
è§¦å‘ profileUpdated äº‹ä»¶
    â†“
Header å’Œ Page ç›‘å¬åˆ°äº‹ä»¶
    â†“
è°ƒç”¨ fetchProfile() é‡æ–°è·å–
    â†“
UI è‡ªåŠ¨æ›´æ–° âœ…
```

## ğŸ”‘ å…³é”®ä¼˜åŠ¿

1. **æ•°æ®ä¸€è‡´æ€§** - `public.profiles` æ˜¯å”¯ä¸€çœŸå®æ¥æº
2. **Google OAuth å‹å¥½** - OAuth è¿”å›çš„ metadata ä¸ä¼šè¦†ç›–ç”¨æˆ·è‡ªå®šä¹‰
3. **è‡ªåŠ¨åŒæ­¥** - Trigger ç¡®ä¿æ–°ç”¨æˆ·è‡ªåŠ¨åˆ›å»º profile
4. **å³æ—¶æ›´æ–°** - äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œæ— éœ€åˆ·æ–°é¡µé¢
5. **ç®€å•æ¸…æ™°** - æ‰€æœ‰ç»„ä»¶éƒ½ä»åŒä¸€ä¸ªè¡¨è¯»å–æ•°æ®

## ğŸ“ API ä½¿ç”¨

### è¯»å–ç”¨æˆ·èµ„æ–™
```typescript
const { data, error } = await supabase
  .from('profiles')
  .select('name, avatar_url')
  .eq('id', user.id)
  .single();
```

### æ›´æ–°ç”¨æˆ·èµ„æ–™
```typescript
const { error } = await supabase
  .from('profiles')
  .update({
    name: displayName,
    avatar_url: avatarUrl
  })
  .eq('id', user.id);
```

### é€šçŸ¥å…¶ä»–ç»„ä»¶åˆ·æ–°
```typescript
window.dispatchEvent(new CustomEvent('profileUpdated'));
```

## âœ¨ é¢„æœŸæ•ˆæœ

1. âœ… ç”¨æˆ·å¯ä»¥ä¿å­˜è‡ªå®šä¹‰å¤´åƒå’Œåå­—
2. âœ… ä¿å­˜åç«‹å³åœ¨ Header å’Œæ¶ˆæ¯æ°”æ³¡ä¸­æ˜¾ç¤º
3. âœ… ç™»å‡ºåå†ç™»å½•ï¼Œè‡ªå®šä¹‰èµ„æ–™ä¿æŒä¸å˜
4. âœ… Google OAuth ä¸ä¼šè¦†ç›–ç”¨æˆ·è‡ªå®šä¹‰
5. âœ… æ— é¡µé¢åˆ·æ–°ï¼Œæµç•…çš„ç”¨æˆ·ä½“éªŒ

## ğŸ§ª æµ‹è¯•æ¸…å•

- [ ] æ–°ç”¨æˆ·æ³¨å†Œåï¼Œprofiles è¡¨è‡ªåŠ¨åˆ›å»ºè®°å½•
- [ ] ç”¨æˆ·å¯ä»¥ä¸Šä¼ å¤´åƒå¹¶ä¿å­˜
- [ ] ç”¨æˆ·å¯ä»¥ä¿®æ”¹åå­—å¹¶ä¿å­˜
- [ ] ä¿å­˜å Header ç«‹å³æ›´æ–°
- [ ] ä¿å­˜åæ¶ˆæ¯æ°”æ³¡ç«‹å³æ›´æ–°
- [ ] ç™»å‡ºåå†ç™»å½•ï¼Œæ˜¾ç¤ºä¿å­˜çš„èµ„æ–™
- [ ] Google ç™»å½•ä¸ä¼šè¦†ç›–è‡ªå®šä¹‰èµ„æ–™

## ğŸ‰ å®Œæˆï¼

æ‰€æœ‰ä»£ç å·²ä¿®æ”¹å®Œæˆï¼Œç°åœ¨ä½¿ç”¨ `public.profiles` è¡¨ä½œä¸ºç”¨æˆ·èµ„æ–™çš„å”¯ä¸€æ¥æºã€‚
